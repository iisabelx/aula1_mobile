<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Dashboard Sensores + Mapa + Mercados</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
    :root {
      --primary-color: #007bff;
      --background-color: #f0f2f5;
      --card-background: #ffffff;
      --text-color: #333;
      --secondary-text-color: #666;
      --border-color: #e0e0e0;
      --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      --border-radius: 12px;
    }
 
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
    }
 
    #map {
      height: 60vh;
      border-bottom: 2px solid var(--border-color);
    }
 
    #info {
      padding: 20px;
      background: var(--card-background);
      box-shadow: var(--shadow);
      border-radius: var(--border-radius);
      margin: 20px;
    }
 
    .section-title {
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--primary-color);
      margin-bottom: 15px;
      border-left: 4px solid var(--primary-color);
      padding-left: 10px;
    }
 
    .sensor-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
 
    .sensor, .supermarket-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
 
    .sensor-icon, .supermarket-icon {
      font-size: 1.5rem;
      line-height: 1;
    }
 
    .sensor-value {
      font-weight: 500;
      color: var(--text-color);
    }
    .compass-arrow {
      display: inline-block;
      transform-origin: center;
      font-size: 1.5rem;
      transition: transform 0.2s;
    }
 
    .supermarket-list {
      margin-top: 20px;
    }
 
    .supermarket-item {
      transition: transform 0.2s, box-shadow 0.2s;
    }
 
    .supermarket-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
 
    .separator {
      height: 1px;
      background-color: var(--border-color);
      margin: 20px 0;
    }
</style>
</head>
<body>
<div id="map"></div>
<div id="info">
<div class="sensor-grid">
<h2 class="section-title">Dados dos Sensores</h2>
<div class="sensor">
<span class="sensor-icon">üìç</span>
<div class="sensor-data">
<span>Localiza√ß√£o:</span>
<span class="sensor-value" id="location">Aguardando...</span>
</div>
</div>
<div class="sensor">
<span class="sensor-icon">üß≠</span>
<div class="sensor-data">
<span>B√∫ssola:</span>
<span class="sensor-value" id="compass">Aguardando...</span>
<span class="compass-arrow" id="arrow">‚¨ÜÔ∏è</span>
</div>
</div>
<div class="sensor">
<span class="sensor-icon">üìê</span>
<div class="sensor-data">
<span>Aceler√¥metro:</span>
<span class="sensor-value" id="motion">Aguardando...</span>
</div>
</div>
<div class="sensor">
<span class="sensor-icon">üí°</span>
<div class="sensor-data">
<span>Luz ambiente:</span>
<span class="sensor-value" id="light">Aguardando...</span>
</div>
</div>
</div>
 
    <div class="separator"></div>
 
    <div class="supermarket-list">
<h2 class="section-title">Mercados Pr√≥ximos</h2>
<div id="supermarkets">Aguardando localiza√ß√£o...</div>
</div>
</div>
 
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // ==== MAPA LEAFLET ====
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
 
    const userIcon = L.divIcon({
      html: "üìç",
      className: "user-icon",
      iconSize: [24, 24],
      iconAnchor: [12, 12]
    });
 
    const supermarketIcon = L.divIcon({
      html: "üõí",
      className: "supermarket-icon",
      iconSize: [24, 24],
      iconAnchor: [12, 12]
    });
 
    const userMarker = L.marker([0, 0], { icon: userIcon }).addTo(map);
    const supermarketMarkers = L.featureGroup().addTo(map);
 
    let lastKnownLocation = null;
 
    function updateLocation(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const currentPos = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      document.getElementById("location").textContent = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
 
      userMarker.setLatLng([lat, lon]);
      map.setView([lat, lon], 16);
 
      if (lastKnownLocation === null || (Math.abs(lastKnownLocation.lat - lat) > 0.001 || Math.abs(lastKnownLocation.lon - lon) > 0.001)) {
        findNearbySupermarkets(lat, lon);
        lastKnownLocation = { lat, lon };
      }
    }
 
    function findNearbySupermarkets(lat, lon) {
      const resultsDiv = document.getElementById("supermarkets");
      resultsDiv.innerHTML = `<div class="sensor-item">Buscando mercados...</div>`;
      supermarketMarkers.clearLayers();
 
      const overpassUrl = "https://overpass-api.de/api/interpreter";
      const overpassQuery = `
        [out:json][timeout:25];
        (
          node["shop"="supermarket"](around:2000, ${lat}, ${lon});
          way["shop"="supermarket"](around:2000, ${lat}, ${lon});
          relation["shop"="supermarket"](around:2000, ${lat}, ${lon});
        );
        out center;
      `;
 
      fetch(overpassUrl, {
        method: 'POST',
        body: overpassQuery,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na resposta da rede: ' + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        resultsDiv.innerHTML = "";
 
        if (data.elements.length === 0) {
          resultsDiv.innerHTML = `<div class="sensor-item">Nenhum mercado encontrado em 2km.</div>`;
          return;
        }
 
        data.elements.forEach(element => {
          const name = element.tags.name || "Mercado Desconhecido";
          const location = [element.lat || element.center.lat, element.lon || element.center.lon];
          const marker = L.marker(location, { icon: supermarketIcon }).addTo(supermarketMarkers);
          marker.bindPopup(`<b>${name}</b>`);
          const item = document.createElement("div");
          item.className = "supermarket-item";
          item.innerHTML = `<span class="supermarket-icon">üõí</span> <span>${name}</span>`;
          resultsDiv.appendChild(item);
        });
      })
      .catch(error => {
        resultsDiv.innerHTML = `<div class="sensor-item">Erro ao buscar dados: ${error.message}</div>`;
        console.error("Erro na busca de mercados:", error);
      });
    }
 
    function error(err) {
      document.getElementById("location").textContent = "Erro: " + err.message;
    }
 
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(updateLocation, error, { enableHighAccuracy: true });
    } else {
      document.getElementById("location").textContent = "Geolocaliza√ß√£o n√£o suportada.";
    }
 
    // ==== B√öSSOLA ====
    if (window.DeviceOrientationEvent) {
      window.addEventListener("deviceorientation", function(event) {
        if (event.absolute || event.webkitCompassHeading !== undefined) {
          const heading = event.webkitCompassHeading || 360 - event.alpha;
          document.getElementById("compass").textContent = heading.toFixed(2) + "¬∞";
          document.getElementById("arrow").style.transform = `rotate(${heading}deg)`;
        }
      }, true);
    } else {
      document.getElementById("compass").textContent = "N√£o suportado.";
    }
 
    // ==== ACELER√îMETRO ====
    if (window.DeviceMotionEvent) {
      window.addEventListener("devicemotion", function(event) {
        const x = event.acceleration.x || 0;
        const y = event.acceleration.y || 0;
        const z = event.acceleration.z || 0;
        document.getElementById("motion").textContent =
          `X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}, Z: ${z.toFixed(2)}`;
      });
    } else {
      document.getElementById("motion").textContent = "N√£o suportado.";
    }
 
    // ==== SENSOR DE LUZ ====
    if ('AmbientLightSensor' in window) {
      try {
        const sensor = new AmbientLightSensor();
        sensor.addEventListener('reading', () => {
          document.getElementById("light").textContent = sensor.illuminance + " lux";
        });
        sensor.start();
      } catch (err) {
        document.getElementById("light").textContent = "Erro: " + err.message;
      }
    } else {
      document.getElementById("light").textContent = "N√£o suportado.";
    }
</script>
</body>
</html>
